Below is the lineage for each field produced by the final SELECT * FROM loan_joined.
For each field, we list:
target field: <field name>
sources: fully qualified source tables in database.schema.table notation and columns from each table if multiple columns are used
transformation: show the exact transformations applied to source columns to generate the target field

target field: exposure_id sources: database.bronze.lending.loan_core.asset_account.account_id transformation: Taken directly as account_id from asset_account.

target field: syndicated_ind sources: No source columns transformation: Hard-coded 'N'.

target field: customer_id sources: database.bronze.core_accounts_service.customer_account.cif_number transformation: Derived by joining parent_account_id in asset_account to account_id in customer_account and selecting cif_number.

target field: application_id sources: database.bronze.lending.loan_app.application.application_id database.bronze.lending.loan_app.applicant.application_id database.bronze.core_accounts_service.customer_account.cif_number transformation: Link the customer_id (from cif_number) to applicant, then to application, and fetch application_id from the application table.

target field: txn_ccy_code sources: database.bronze.core_accounts_service.customer_account.currency database.bronze.lending.loan_core.loan_summary.currency transformation: If loan_summary.currency is null, use customer_account.currency; else use loan_summary.currency.

target field: interest_outstanding_amt sources: database.bronze.lending.loan_core.loan_summary.normal_interest_accrued database.bronze.lending.loan_core.loan_summary.normal_interest_paid database.bronze.lending.loan_core.loan_summary.normal_interest_waived_off database.bronze.lending.loan_core.loan_summary.normal_interest_written_off database.bronze.lending.loan_core.loan_summary (calculated interest_charges) transformation: interest_outstanding_amt = (normal_interest_accrued - (normal_interest_paid + normal_interest_waived_off + normal_interest_written_off) + interest_charges), coalesced to 0.

target field: prin_outstanding_amt sources: database.bronze.lending.loan_core.loan_summary.principal_balance database.bronze.lending.loan_core.loan_summary.principal_paid database.bronze.lending.loan_core.loan_summary.principal_written_off database.bronze.lending.loan_core.loan_summary.principal_waived_off transformation: prin_outstanding_amt = principal_balance - (principal_paid + principal_written_off + principal_waived_off), coalesced to 0.

target field: act_lead_arranger_ind sources: No source columns transformation: Hard-coded 'N'.

target field: entity_code sources: No source columns transformation: Hard-coded 'SG01'.

target field: exposure_start_date sources: database.bronze.lending.loan_core.loan_disbursement_detail.disbursement_date database.bronze.lending.loan_core.asset_account.account_id (to join) transformation: exposure_start_date = disbursement_date from loan_disbursement_detail for the given account_id.

target field: disbursed_amount sources: database.bronze.lending.loan_core.loan_disbursement_detail.disbursed_amount transformation: Taken directly from disbursed_amount in loan_disbursement_detail for the given account_id.

target field: exposure_end_date sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.asset_account.sub_status database.bronze.lending.loan_core.asset_account.closing_timestamp database.bronze.lending.loan_core.loan_repayment_schedule.installment_due_date (aggregated as scheduled_end_date) database.bronze.lending.loan_core.asset_account.opening_timestamp database.bronze.lending.loan_core.asset_account_parameter.parameter_value (for accelerated_timestamp) transformation: If current_status in ('ACTIVE','PENDING_CLOSURE') and sub_status='NORMAL', use scheduled_end_date from repayment_schedule.
If current_status='CLOSED' and sub_status='NORMAL', use closing_timestamp as date.
Else use accelerated_date derived from accelerated_timestamp parameter in asset_account_parameter.

target field: facility_id sources: database.bronze.lending.loan_core.asset_account.parent_account_id transformation: facility_id = parent_account_id from asset_account.

target field: book_type sources: No source columns transformation: Hard-coded 'B'.

target field: days_past_due sources: database.bronze.lending.loan_core.loan_repayment_detail.days_past_due transformation: Take days_past_due directly from loan_repayment_detail for the given account_id, coalesce to 0 if null.

target field: customer_days_past_due sources: database.bronze.lending.loan_core.loan_repayment_detail.days_past_due database.bronze.core_accounts_service.customer_account.cif_number database.bronze.lending.loan_core.asset_account.parent_account_id transformation: Compute max days_past_due across all exposures linked to the same cif_number and facility_id. This is the maximum of days_past_due for that customer/facility combination.

target field: past_due_ind sources: computed from customer_days_past_due transformation: If customer_days_past_due > 0 then 'Y' else 'N'.

target field: curr_ltv sources: No source columns transformation: null.

target field: unconditional_cancel_ind sources: No source columns transformation: 'Y'.

target field: bank_product_code sources: database.bronze.lending.loan_core.asset_account.product_code transformation: If product_code='BIZ_FLEXI_CREDIT_TERM_LOAN' then 'FLEXI_LOAN' else use product_code from asset_account.

target field: country_code sources: database.bronze.core_accounts_service.customer_account.country_code transformation: Taken directly from customer_account.country_code.

target field: drawn_amount sources: Uses prin_outstanding_amt as computed from loan_summary principal fields. transformation: drawn_amount = prin_outstanding_amt (the principal currently outstanding).

target field: undrawn_amount sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.asset_account_parameter.offered_limit (sanctioned_limit) loan_summary principal components from the facility level via parent_account_id transformation: If current_status in ('WRITTEN_OFF', 'CLOSED') then undrawn_amount=0 else undrawn_amount = sanctioned_limit - drawn_amount calculated from summary of exposures under the facility.

target field: fairvalue_hier sources: No source columns transformation: null.

target field: ifrs9_class_type sources: No source columns transformation: 'AC'.

target field: int_rate_sensitive_ind sources: No source columns transformation: 'Y'.

target field: interest_rate sources: database.bronze.lending.loan_core.loan_repayment_detail.effective_interest_rate transformation: interest_rate = effective_interest_rate from loan_repayment_detail.

target field: interest_rate_type sources: bank_product_code derived above transformation: If bank_product_code='FLEXI_LOAN' then 'FIX_TYPE' else null.

target field: past_due_date sources: database.bronze.lending.loan_core.asset_account_parameter.parameter_value (accelerated_timestamp) database.bronze.lending.loan_core.loan_repayment_schedule.installment_due_date (for past_due_date) transformation: past_due_date = accelerated_date if present, otherwise the earliest overdue installment_due_date from repayment_schedule.

target field: pledged_amt sources: No source columns transformation: 0.

target field: repricing_date sources: No source columns transformation: null.

target field: restructured_ind sources: No source columns transformation: 'N'.

target field: restructured_date sources: No source columns transformation: null.

target field: ultimate_risk_country sources: database.bronze.core_accounts_service.customer_account.country_code transformation: Taken directly from customer_account.country_code as ultimate_risk_country.

target field: ultimate_risk_cprt sources: bank_product_code transformation: If bank_product_code='FLEXI_LOAN' then 'UNCORP' else null.

target field: loan_purpose_type sources: bank_product_code transformation: If bank_product_code='FLEXI_LOAN' then 'OTH' else null.

target field: bank_asset_class_code sources: bank_product_code transformation: If bank_product_code='FLEXI_LOAN' then 'RR' else null.

target field: poci_ind sources: No source columns transformation: null.

target field: acct_block_code sources: database.bronze.lending.loan_core.asset_account_parameter.reason_code database.bronze.lending.loan_core.asset_account_restriction.reason_code database.bronze.lending.loan_core.asset_account_parameter.accelerated_reason_code transformation: acct_block_code determined by matching reason_codes from parameter/restriction against sets of conditions. If matched with certain categories, return 'A','B','C','D', else null.

target field: mas612_qualitative_criteria sources: acct_block_code from above logic database.bronze.lending.loan_core.loan_repayment_detail.days_past_due transformation: If acct_block_code='A' or days_past_due>=120 then 'LS' else 'PS' (Other states like 'SS','SM' not triggered by given logic here).

target field: defaulted_ind sources: mas612_qualitative_criteria transformation: If mas612_qualitative_criteria in ('SS','LS') then 'Y', else 'N'.

target field: impairment_status_ind sources: No source columns transformation: 'N'.

target field: gl_id sources: No direct source columns used for logic here transformation: Hard-coded '105112'.

target field: original_interest_rate sources: database.bronze.lending.loan_core.asset_account_parameter.offered_interest_rate transformation: original_interest_rate = offered_interest_rate from parameter_value associated with facility_id.

target field: high_dpd_cbs_ind sources: days_past_due transformation: If days_past_due > 60 then 'Y' else 'N'.

target field: next_payment_date sources: database.bronze.lending.loan_core.loan_repayment_schedule.installment_due_date transformation: next_payment_date is determined from the earliest not fully paid installment whose due_date >= current date. Taken from repayment_schedule_enriched.

target field: acct_customer_role sources: No source columns transformation: 'PRIMARY'.

target field: proj_fin_country_code sources: No source columns transformation: null.

target field: proj_fin_sub_sector sources: No source columns transformation: null.

target field: sanctioned_limit sources: database.bronze.lending.loan_core.asset_account_parameter.offered_limit transformation: sanctioned_limit = offered_limit from parameter_value for facility_id.

target field: extended_credit_fac_ind sources: No direct source logic here transformation: 'N'.

target field: gross_outstanding_amt sources: prin_outstanding_amt interest_outstanding_amt transformation: gross_outstanding_amt = interest_outstanding_amt + prin_outstanding_amt.

target field: unsecured_ind sources: bank_product_code transformation: If bank_product_code='FLEXI_LOAN' then 'Y' else 'N'.

target field: orig_ltv sources: No source columns transformation: null.

target field: branch_id sources: No source columns transformation: null.

target field: data_source sources: No source columns transformation: 'LOAN-CORE'.

target field: upfront_processing_fee sources: No source columns transformation: null.

target field: upfront_unamortize_fee sources: No source columns transformation: null.

target field: syndicated_amt sources: No source columns transformation: null.

target field: lead_arranger_amt sources: No source columns transformation: null.

target field: foreclosed_ind sources: No source columns transformation: null.

target field: free_credit_balance_amt sources: No source columns transformation: null.

target field: interest_bearing_balance_amt sources: prin_outstanding_amt transformation: interest_bearing_balance_amt = prin_outstanding_amt.

target field: age_in_days sources: database.bronze.lending.loan_core.asset_account.opening_timestamp transformation: age_in_days = '2024-11-20'::date - opening_timestamp::date.

target field: interest_charges sources: database.bronze.lending.loan_core.loan_summary.penal_interest_balance database.bronze.lending.loan_core.loan_summary.penal_interest_paid database.bronze.lending.loan_core.loan_summary.penal_interest_waived_off database.bronze.lending.loan_core.loan_summary.penal_interest_written_off transformation: interest_charges = penal_interest_balance - (penal_interest_paid + penal_interest_waived_off + penal_interest_written_off) as computed in loan_summary_enriched.

target field: bank_charges sources: No direct source columns transformation: 0.

target field: late_payment_charges sources: No direct source columns transformation: 0.

target field: action_initiated_ind sources: acct_block_code transformation: If acct_block_code is not null then 'Y' else 'N'.

target field: action_initiated_type sources: acct_block_code transformation: If action_initiated_ind='Y', 'Collection', else null.

target field: transitional_arrangement_ind sources: No source columns transformation: 'N'.

target field: writeoff_amt sources: database.bronze.lending.loan_core.loan_summary.principal_written_off database.bronze.lending.loan_core.loan_summary.normal_interest_written_off database.bronze.lending.loan_core.loan_summary.penal_interest_written_off transformation: writeoff_amt = principal_written_off + normal_interest_written_off + penal_interest_written_off.

target field: recovery_amt sources: No source columns transformation: null.

target field: tot_writeoff_qtd sources: computed as current_written_off_amount - previous_quarter_written_off_amount in loan_summary_enriched which are sums of principal_written_off, normal_interest_written_off, penal_interest_written_off at quarter end. transformation: tot_writeoff_qtd = total current writeoff minus previous quarter writeoff amounts.

target field: writeoff_date sources: database.bronze.lending.loan_core.asset_account.updated_at writeoff_amt database.bronze.lending.loan_core.asset_account.current_status transformation: If current_status in ('WRITTEN_OFF', 'CLOSED', 'PENDING_CLOSURE') and writeoff_amt > 0 then writeoff_date = updated_at as date, else null.

target field: account_writeoff_ind sources: database.bronze.lending.loan_core.asset_account.current_status writeoff_amt transformation: If current_status in ('WRITTEN_OFF','CLOSED','PENDING_CLOSURE') and writeoff_amt>0 then 'Y', else 'N'.

target field: account_mas635_ind sources: No source columns transformation: 'N'.

target field: last_payment_date sources: database.bronze.lending.loan_core.loan_transaction_repayment_schedule_mapping.transaction_timestamp transformation: last_payment_date = max(transaction_timestamp) from loan_transaction_repayment_schedule_mapping for the account.

target field: acct_status_code sources: database.bronze.lending.loan_core.asset_account.current_status transformation: acct_status_code = current_status from asset_account.

target field: sub_status sources: database.bronze.lending.loan_core.asset_account.sub_status transformation: sub_status directly from asset_account.

target field: acct_status_date sources: database.bronze.lending.loan_core.loan_repayment_detail.updated_at transformation: acct_status_date = loan_repayment_detail.updated_at date.

target field: gen_allowance_amt sources: No source columns transformation: 0.

target field: market_value sources: No source columns transformation: 0.

target field: exp_revolving_ind sources: No source columns transformation: 'Y'.

target field: channel_type sources: No source columns transformation: null.

target field: materiality_threshold sources: No source columns transformation: 5000000.

target field: nominal_threshold sources: No source columns transformation: 0.

target field: encumbrance_status_ind sources: No source columns transformation: null.

target field: gl_department sources: No source columns transformation: '241120'.

target field: suspension_ind sources: database.bronze.lending.loan_core.asset_account_parameter.suspension_ind database.bronze.lending.loan_core.asset_account_restriction.reason_code transformation: If suspension_ind in parameters is set or if reason_codes exist in restrictions (drawdown_blocked), return that string. Coalesce to 'false' if not set.

target field: minimum_payment_ind sources: days_past_due transformation: If days_past_due > 0 then 'N' else 'Y'.

target field: gl_lob sources: No source columns transformation: '110'.

target field: gl_location sources: database.bronze.onboarding_customer_master.biz_customer data (place_of_incorporation) transformation: If place_of_incorporation='SG' then '1100', else '2100'. If null default '1100'.

target field: gl_intercompany sources: No source columns transformation: '9999'.

target field: gl_product sources: unsecured_ind transformation: If unsecured_ind='Y' then '110200' else '110300'.

target field: gl_customer_segment sources: database.silver.biz.ssic_code_mapping.gl_customer_type_code database.onboarding_customer_master.biz_customer fields mapped through ssic transformation: gl_customer_segment = gl_customer_type_code from ssic_code_mapping joined via customer's SSIC code.

target field: gl_future1 sources: No source columns transformation: '999'.

target field: gl_future2 sources: No source columns transformation: '999999'.

target field: maturity_date sources: loan_repayment_schedule_enriched.scheduled_end_date transformation: maturity_date = scheduled_end_date from repayment_schedule.

target field: a_score sources: No source columns transformation: null.

target field: a_score_segment sources: No source columns transformation: null.

target field: bureau_grade sources: No source columns transformation: null.

target field: version_id sources: No source columns transformation: null.

target field: junior_charge_ind sources: No source columns transformation: null.

target field: _has_accelerated_loans sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.asset_account.sub_status transformation: Boolean aggregated at facility_id level: if any account at facility level is active/written_off and sub_status='DEFAULT' or written_off, then true, else false.

target field: _dpd_count_exceeded sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.loan_repayment_detail.days_past_due transformation: If any account at facility level is in ('ACTIVE','CLOSED','PENDING_CLOSURE','WRITTEN_OFF') and repayment_detail.status='ACTIVE' and days_past_due>=4, then true.

target field: customer_earliest_due_date sources: Computed from joining customer to loan_repayment_schedule_enriched. Also possibly from retail_loan_data_source for earliest due date. transformation: customer_earliest_due_date = least of earliest due date from MSME and Retail sources matched via customer relationships.

target field: transactor_ind sources: No source columns transformation: 'N'.

target field: _indefinite_block_dpd_count_exceeded sources: database.bronze.lending.loan_core.asset_account_restriction.reason_code _dpd_count_exceeded conditions transformation: If reason_codes contain 'DPD_60' or dpd>=60 at facility level, then true else false.

target field: installment_amount sources: database.bronze.lending.loan_core.loan_repayment_schedule.installment_balance transformation: installment_amount = max installment_balance for not fully paid installments from repayment_schedule.

target field: unused_limit sources: sanctioned_limit principal outstanding amounts from all exposures under facility transformation: unused_limit = greatest(0, sanctioned_limit - sum of prin_outstanding_amt over accounts of the facility).

target field: overdue_amount sources: loan_repayment_schedule_source principal_overdue, normal_interest_overdue, penal_interest_overdue transformation: overdue_amount = principal_overdue_sum + normal_interest_overdue_sum + penal_interest_overdue_sum aggregated for not fully paid installments.

target field: bucket_dpd sources: loan_repayment_detail.days_past_due transformation: bucket_dpd = days_past_due from repayment_detail.

target field: bank_sub_product_code sources: database.bronze.lending.loan_core.asset_account.product_variant_code transformation: bank_sub_product_code = product_variant_code from asset_account.

target field: updated_at sources: database.bronze.lending.loan_core.asset_account._source_updated_at database.bronze.core_accounts_service.customer_account._source_updated_at database.bronze.lending.loan_core.asset_account_parameter._source_updated_at database.bronze.lending.loan_core.loan_summary._source_updated_at database.bronze.lending.loan_core.loan_disbursement_detail._source_updated_at database.bronze.lending.loan_core.loan_repayment_detail._source_updated_at database.bronze.lending.loan_core.asset_account_restriction._source_updated_at database.bronze.lending.loan_core.loan_repayment_schedule._source_updated_at transformation: updated_at = greatest of these timestamps from all involved source tables.

target field: _bronze_updated_at sources: database.bronze.lending.loan_core.asset_account._bronze_updated_at database.bronze.core_accounts_service.customer_account._bronze_updated_at database.bronze.lending.loan_core.asset_account_parameter._bronze_updated_at database.bronze.lending.loan_core.loan_summary._bronze_updated_at database.bronze.lending.loan_core.loan_disbursement_detail._bronze_updated_at database.bronze.lending.loan_core.loan_repayment_detail._bronze_updated_at database.bronze.lending.loan_core.asset_account_restriction._bronze_updated_at database.bronze.lending.loan_core.loan_repayment_schedule._bronze_updated_at transformation: _bronze_updated_at = greatest of these bronze updated timestamps from all involved source tables.

target field: _valid_date sources: No source columns transformation: Set to '2024-11-20'::date.

target field: _silver_loaded_at sources: No source columns transformation: current_timestamp.

