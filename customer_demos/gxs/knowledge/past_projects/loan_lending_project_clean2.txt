Below is the lineage for each field produced by the final SELECT * FROM loan_joined.
For each field, we list:
target field: <field name>
sources: fully qualified source tables in database.schema.table notation and columns from each table if multiple columns are used
transformation: show the exact transformations applied to source columns to generate the target field

Do not mention intermediate CTEs, only the ultimate base source tables and their columns.
Do not mention any SCD or row_number logic.
Replace all double underscores “__” with “.” in referenced source objects.

target field: exposure_id sources: database.bronze.lending.loan_core.asset_account.account_id transformation: Directly from asset_account.account_id

target field: syndicated_ind sources: No columns transformation: Hard-coded 'N'

target field: customer_id sources: database.bronze.core_accounts_service.customer_account.cif_number transformation: Join asset_account.parent_account_id to customer_account.account_id and take cif_number.

target field: application_id sources: database.bronze.lending.loan_app.application.application_id database.bronze.lending.loan_app.applicant.application_id database.bronze.core_accounts_service.customer_account.cif_number transformation: Link customer_id (from cif_number) to applicant, then to application, and select application_id.

target field: txn_ccy_code sources: database.bronze.lending.loan_core.loan_summary.currency database.bronze.core_accounts_service.customer_account.currency transformation: If loan_summary.currency is null, use customer_account.currency; else use loan_summary.currency.

target field: interest_outstanding_amt sources: database.bronze.lending.loan_core.loan_summary.normal_interest_accrued database.bronze.lending.loan_core.loan_summary.normal_interest_paid database.bronze.lending.loan_core.loan_summary.normal_interest_waived_off database.bronze.lending.loan_core.loan_summary.normal_interest_written_off database.bronze.lending.loan_core.loan_summary.penal_interest fields indirectly (for interest_charges) transformation: interest_outstanding_amt = (normal_interest_accrued - (normal_interest_paid+normal_interest_waived_off+normal_interest_written_off) + interest_charges), coalesced to 0.

target field: prin_outstanding_amt sources: database.bronze.lending.loan_core.loan_summary.principal_balance database.bronze.lending.loan_core.loan_summary.principal_paid database.bronze.lending.loan_core.loan_summary.principal_written_off database.bronze.lending.loan_core.loan_summary.principal_waived_off transformation: prin_outstanding_amt = principal_balance - (principal_paid+principal_written_off+principal_waived_off), coalesced to 0.

target field: act_lead_arranger_ind sources: No columns transformation: 'N'

target field: entity_code sources: No columns transformation: 'SG01'

target field: exposure_start_date sources: database.bronze.lending.loan_core.loan_disbursement_detail.disbursement_date transformation: exposure_start_date = disbursement_date from loan_disbursement_detail for the given account_id

target field: disbursed_amount sources: database.bronze.lending.loan_core.loan_disbursement_detail.disbursed_amount transformation: Directly from disbursed_amount

target field: exposure_end_date sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.asset_account.sub_status database.bronze.lending.loan_core.asset_account.closing_timestamp database.bronze.lending.loan_core.asset_account_parameter.parameter_value (accelerated_reason_code for accelerated_date) database.bronze.lending.loan_core.loan_repayment_schedule.installment_due_date (scheduled_end_date) transformation: If current_status in ('ACTIVE','PENDING_CLOSURE') and sub_status='NORMAL', use scheduled_end_date from repayment_schedule.
If current_status='CLOSED' and sub_status='NORMAL', use closing_timestamp date.
Else use accelerated_date (from accelerated_timestamp parameter).

target field: facility_id sources: database.bronze.lending.loan_core.asset_account.parent_account_id transformation: facility_id = parent_account_id

target field: book_type sources: No columns transformation: 'B'

target field: days_past_due sources: database.bronze.lending.loan_core.loan_repayment_detail.days_past_due transformation: Coalesce days_past_due to 0 if null

target field: customer_days_past_due sources: database.bronze.lending.loan_core.loan_repayment_detail.days_past_due database.bronze.core_accounts_service.customer_account.cif_number database.bronze.lending.loan_core.asset_account.parent_account_id transformation: Max days_past_due over all exposures linked to same cif_number and facility_id.

target field: past_due_ind sources: customer_days_past_due transformation: If customer_days_past_due >0 then 'Y' else 'N'

target field: curr_ltv sources: No columns transformation: null

target field: unconditional_cancel_ind sources: No columns transformation: 'Y'

target field: bank_product_code sources: database.bronze.lending.loan_core.asset_account.product_code transformation: If product_code='FLEXI_LOAN_TERM_LOAN' then 'FLEXI_LOAN' else product_code

target field: country_code sources: database.bronze.core_accounts_service.customer_account.country_code transformation: Direct from country_code

target field: drawn_amount sources: prin_outstanding_amt (as previously computed) transformation: drawn_amount = prin_outstanding_amt

target field: undrawn_amount sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.asset_account_parameter.offered_limit (sanctioned_limit) transformation: If current_status in ('WRITTEN_OFF','CLOSED') then undrawn_amount=0 else undrawn_amount = sanctioned_limit - drawn_amount at facility level.

target field: fairvalue_hier sources: No columns transformation: null

target field: ifrs9_class_type sources: No columns transformation: 'AC'

target field: int_rate_sensitive_ind sources: No columns transformation: 'Y'

target field: interest_rate sources: database.bronze.lending.loan_core.loan_repayment_detail.effective_interest_rate transformation: interest_rate = effective_interest_rate from loan_repayment_detail

target field: interest_rate_type sources: bank_product_code transformation: If bank_product_code in ('FLEXI_LOAN','FLEXI_LOAN_BALANCE_TRANSFER') then 'FIX_TYPE' else null

target field: past_due_date sources: database.bronze.lending.loan_core.asset_account_parameter.parameter_value (accelerated_timestamp) database.bronze.lending.loan_core.loan_repayment_schedule.installment_due_date (for past_due_date) transformation: past_due_date = accelerated_date if present, else earliest not fully paid past due installment_due_date.

target field: pledged_amt sources: No columns transformation: 0

target field: repricing_date sources: No columns transformation: null

target field: restructured_ind sources: No columns transformation: 'N'

target field: restructured_date sources: No columns transformation: null

target field: ultimate_risk_country sources: database.bronze.core_accounts_service.customer_account.country_code transformation: ultimate_risk_country = country_code from customer_account

target field: ultimate_risk_cprt sources: bank_product_code transformation: If bank_product_code in ('FLEXI_LOAN','FLEXI_LOAN_BALANCE_TRANSFER') then 'NAT_PERSON' else null

target field: loan_purpose_type sources: bank_product_code transformation: If bank_product_code in ('FLEXI_LOAN','FLEXI_LOAN_BALANCE_TRANSFER') then 'OTH_LOAN' else null

target field: bank_asset_class_code sources: bank_product_code transformation: If bank_product_code in ('FLEXI_LOAN','FLEXI_LOAN_BALANCE_TRANSFER') then 'RR' else null

target field: poci_ind sources: No columns transformation: null

target field: acct_block_code sources: database.bronze.lending.loan_core.asset_account_parameter.reason_code database.bronze.lending.loan_core.asset_account_restriction.reason_code database.bronze.lending.loan_core.asset_account_parameter.accelerated_reason_code transformation: Determine acct_block_code by matching reason codes to categories ('A','B','C','D'). If no match, null.

target field: mas612_qualitative_criteria sources: acct_block_code database.bronze.lending.loan_core.loan_repayment_detail.days_past_due transformation: If acct_block_code='A' or days_past_due>=120 then 'LS', else 'PS' (and checks if array_contains('SS','SM','LS','PS') as per logic, final fallback 'PS').

target field: defaulted_ind sources: mas612_qualitative_criteria transformation: If mas612_qualitative_criteria in ('SS','LS') then 'Y' else 'N'

target field: impairment_status_ind sources: No columns transformation: 'N'

target field: gl_id sources: No direct columns for logic transformation: 105112 (hard-coded number)

target field: original_interest_rate sources: database.bronze.lending.loan_core.asset_account_parameter.offered_interest_rate transformation: original_interest_rate = offered_interest_rate from parameters

target field: high_dpd_cbs_ind sources: days_past_due transformation: If days_past_due>60 then 'Y' else 'N'

target field: next_payment_date sources: loan_repayment_schedule.installment_due_date transformation: next_payment_date = earliest future unpaid installment due_date from loan_repayment_schedule

target field: acct_customer_role sources: No columns transformation: 'PRIMARY'

target field: proj_fin_country_code sources: No columns transformation: null

target field: proj_fin_sub_sector sources: No columns transformation: null

target field: sanctioned_limit sources: database.bronze.lending.loan_core.asset_account_parameter.offered_limit transformation: sanctioned_limit = offered_limit from parameters

target field: extended_credit_fac_ind sources: No columns (no logic) transformation: 'N'

target field: gross_outstanding_amt sources: prin_outstanding_amt interest_outstanding_amt transformation: gross_outstanding_amt = interest_outstanding_amt + prin_outstanding_amt

target field: unsecured_ind sources: bank_product_code transformation: If bank_product_code in ('FLEXI_LOAN','FLEXI_LOAN_BALANCE_TRANSFER') then 'Y' else 'N'

target field: orig_ltv sources: No columns transformation: null

target field: branch_id sources: No columns transformation: null

target field: data_source sources: No columns transformation: 'LOAN-CORE'

target field: upfront_processing_fee sources: database.bronze.lending.loan_core.loan_summary.metadata transformation: upfront_processing_fee = parse_json(metadata)['balanceTransferDetails']['processingFeeAmount'] as float

target field: upfront_unamortize_fee sources: database.bronze.lending.loan_core.loan_summary.metadata transformation: upfront_unamortize_fee = parse_json(metadata)['balanceTransferDetails']['unrecognizedFeeAmount'] as float

target field: syndicated_amt sources: No columns transformation: null

target field: lead_arranger_amt sources: No columns transformation: null

target field: foreclosed_ind sources: No columns transformation: null

target field: free_credit_balance_amt sources: No columns transformation: null

target field: interest_bearing_balance_amt sources: prin_outstanding_amt transformation: interest_bearing_balance_amt = prin_outstanding_amt

target field: age_in_days sources: database.bronze.lending.loan_core.asset_account.opening_timestamp transformation: age_in_days = '2024-11-20'::date - opening_timestamp::date

target field: interest_charges sources: database.bronze.lending.loan_core.loan_summary.penal_interest_balance database.bronze.lending.loan_core.loan_summary.penal_interest_paid database.bronze.lending.loan_core.loan_summary.penal_interest_waived_off database.bronze.lending.loan_core.loan_summary.penal_interest_written_off transformation: interest_charges = penal_interest_balance - (penal_interest_paid+penal_interest_waived_off+penal_interest_written_off)

target field: bank_charges sources: No columns transformation: 0

target field: late_payment_charges sources: No columns transformation: 0

target field: action_initiated_ind sources: acct_block_code transformation: If acct_block_code not null then 'Y' else 'N'

target field: action_initiated_type sources: acct_block_code transformation: If action_initiated_ind='Y' then 'Collection' else null

target field: transitional_arrangement_ind sources: No columns transformation: 'N'

target field: writeoff_amt sources: database.bronze.lending.loan_core.loan_summary.principal_written_off database.bronze.lending.loan_core.loan_summary.normal_interest_written_off database.bronze.lending.loan_core.loan_summary.penal_interest_written_off transformation: writeoff_amt = principal_written_off + normal_interest_written_off + penal_interest_written_off

target field: recovery_amt sources: database.bronze.lending.loan_core.loan_recovery_detail.amount transformation: Sum of amount from loan_recovery_detail_agg for the account_id, coalesce to 0.

target field: tot_writeoff_qtd sources: previous_quarter_written_off_amount and current_written_off_amount (calculated from loan_summary) transformation: tot_writeoff_qtd = current_written_off_amount - previous_quarter_written_off_amount

target field: writeoff_date sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.loan_summary (to check writeoff_amt >0) database.bronze.lending.loan_core.asset_account.updated_at transformation: If current_status in ('WRITTEN_OFF','CLOSED','PENDING_CLOSURE') and writeoff_amt>0 then writeoff_date=updated_at date else null

target field: account_writeoff_ind sources: current_status writeoff_amt transformation: If current_status in ('WRITTEN_OFF','CLOSED','PENDING_CLOSURE') and writeoff_amt>0 then 'Y' else 'N'

target field: account_mas635_ind sources: database.silver.onboarding.customer_master.annual_income transformation: If annual_income>=120000 then 'Y' else 'N'

target field: last_payment_date sources: database.bronze.lending.loan_core.loan_transaction_repayment_schedule_mapping.transaction_timestamp transformation: last_payment_date = max(transaction_timestamp) from loan_transaction_repayment_schedule_mapping for that account

target field: acct_status_code sources: database.bronze.lending.loan_core.asset_account.current_status transformation: acct_status_code = current_status

target field: sub_status sources: database.bronze.lending.loan_core.asset_account.sub_status transformation: sub_status directly from asset_account

target field: acct_status_date sources: database.bronze.lending.loan_core.loan_repayment_detail.updated_at transformation: acct_status_date = updated_at date from loan_repayment_detail

target field: gen_allowance_amt sources: No columns transformation: 0

target field: market_value sources: No columns transformation: 0

target field: bt_exposure_id sources: database.bronze.lending.loan_core.asset_account_parameter.asset_account_converted_from bank_product_code transformation: If bank_product_code='FLEXI_LOAN' then bt_exposure_id = asset_account_converted_from else null

target field: exp_revolving_ind sources: No columns transformation: 'Y'

target field: channel_type sources: No columns transformation: null

target field: materiality_threshold sources: No columns transformation: 0

target field: nominal_threshold sources: No columns transformation: 0

target field: encumbrance_status_ind sources: No columns transformation: null

target field: gl_department sources: No columns transformation: '311110'

target field: suspension_ind sources: database.bronze.lending.loan_core.asset_account_parameter.suspension_ind database.bronze.lending.loan_core.asset_account_restriction.reason_code transformation: suspension_ind = If suspension_ind from parameters not null use that; else if reason_codes exist then 'true' else 'false'.

target field: minimum_payment_ind sources: days_past_due transformation: If days_past_due>0 then 'N' else 'Y'

target field: gl_lob sources: No columns transformation: '110'

target field: gl_location sources: No columns transformation: '1100'

target field: gl_intercompany sources: No columns transformation: '9999'

target field: gl_product sources: No columns transformation: '110200'

target field: gl_customer_segment sources: No direct fields used for logic here transformation: '101'

target field: gl_future1 sources: No columns transformation: '999'

target field: gl_future2 sources: No columns transformation: '999999'

target field: maturity_date sources: loan_repayment_schedule.scheduled_end_date transformation: maturity_date = scheduled_end_date from repayment_schedule_enriched

target field: a_score sources: No columns transformation: null

target field: a_score_segment sources: No columns transformation: null

target field: bureau_grade sources: No columns transformation: null

target field: version_id sources: No columns transformation: null

target field: junior_charge_ind sources: No columns transformation: null

target field: _has_accelerated_loans sources: database.bronze.lending.loan_core.asset_account.current_status database.bronze.lending.loan_core.asset_account.sub_status transformation: Derived boolean based on if any account at facility level is active/written_off and sub_status='DEFAULT' or written_off.

target field: _dpd_count_exceeded sources: days_past_due from loan_repayment_detail current_status from asset_account transformation: True if any account at facility is in an eligible status and has days_past_due >=4.

target field: customer_earliest_due_date sources: loan_repayment_schedule_enriched.earliest_due_date cif_number from customer_account transformation: Minimum earliest_due_date across all exposures for that customer.

target field: transactor_ind sources: No columns transformation: 'N'

target field: _indefinite_block_dpd_count_exceeded sources: account_restriction_enriched.reason_codes dpd conditions from credit_suppress_flags transformation: True if 'DPD_60' in reason_codes or dpd_count_exceeded at >=60 days; else false.

target field: installment_amount sources: loan_repayment_schedule.installment_balance transformation: installment_amount = max installment_balance of not fully paid installments

target field: unused_limit sources: sanctioned_limit from parameters prin_outstanding_amt from all exposures under facility transformation: unused_limit = greatest(0, sanctioned_limit - sum of prin_outstanding_amt over facility accounts)

target field: overdue_amount sources: loan_repayment_schedule.principal_overdue loan_repayment_schedule.normal_interest_overdue loan_repayment_schedule.penal_interest_overdue transformation: overdue_amount = sum of principal_overdue + normal_interest_overdue + penal_interest_overdue for not fully paid installments

target field: bucket_dpd sources: loan_repayment_detail.days_past_due transformation: bucket_dpd = days_past_due

target field: bank_sub_product_code sources: database.bronze.lending.loan_core.asset_account.product_variant_code transformation: bank_sub_product_code = product_variant_code

target field: updated_at sources: database.bronze.lending.loan_core.asset_account._source_updated_at database.bronze.core_accounts_service.customer_account._source_updated_at database.silver.onboarding.customer_master.updated_at database.bronze.lending.loan_core.asset_account_parameter._source_updated_at database.bronze.lending.loan_core.loan_summary._source_updated_at database.bronze.lending.loan_core.loan_disbursement_detail._source_updated_at database.bronze.lending.loan_core.loan_repayment_detail._source_updated_at database.bronze.lending.loan_core.asset_account_restriction._source_updated_at database.bronze.lending.loan_core.loan_repayment_schedule._source_updated_at transformation: updated_at = greatest of all these source updated_at timestamps

target field: _bronze_updated_at sources: database.bronze.lending.loan_core.asset_account._bronze_updated_at database.bronze.core_accounts_service.customer_account._bronze_updated_at database.silver.onboarding.customer_master._silver_loaded_at database.bronze.lending.loan_core.asset_account_parameter._bronze_updated_at database.bronze.lending.loan_core.loan_summary._bronze_updated_at database.bronze.lending.loan_core.loan_disbursement_detail._bronze_updated_at database.bronze.lending.loan_core.loan_repayment_detail._bronze_updated_at database.bronze.lending.loan_core.asset_account_restriction._bronze_updated_at database.bronze.lending.loan_core.loan_repayment_schedule._bronze_updated_at transformation: _bronze_updated_at = greatest of these bronze updated timestamps

target field: _valid_date sources: No columns transformation: '2024-11-20'::date

target field: _silver_loaded_at sources: No columns transformation: current_timestamp